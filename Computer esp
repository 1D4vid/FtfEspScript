local computerInfo = {}

local function isComputerCandidate(model)
    if not model or not model:IsA("Model") then return false end
    local lower = model.Name:lower()
    return lower:find("computer") or lower:find("pc") or lower:find("terminal") or lower:find("console")
end

local function getModelState(model)
    if not model then return nil end
    local boolNames = {"Hacked", "IsHacked", "HackedValue"}
    for _,n in ipairs(boolNames) do
        local v = model:FindFirstChild(n, true)
        if v and v:IsA("BoolValue") then return v.Value and "hacked" or "ready" end
    end
    local strNames = {"State", "HackState", "Status", "Phase"}
    for _,n in ipairs(strNames) do
        local s = model:FindFirstChild(n, true)
        if s and s:IsA("StringValue") then return tostring(s.Value):lower() end
    end
    local intNames = {"State", "StateValue", "HackProgress", "Progress"}
    for _,n in ipairs(intNames) do
        local iv = model:FindFirstChild(n, true)
        if iv and iv:IsA("IntValue") then
            if iv.Value <= 0 then return "ready" end
            if iv.Value >= 1 then return "hacked" end
            return tostring(iv.Value)
        end
    end
    local attrs = {"HackState", "State", "Status"}
    for _,a in ipairs(attrs) do
        local at = model:GetAttribute(a)
        if at ~= nil then return tostring(at):lower() end
    end
    return nil
end

local function stateColorsFor(s)
    if not s then return Color3.fromRGB(120, 200, 255), Color3.fromRGB(20, 40, 80) end
    s = tostring(s):lower()
    if s:find("ready") or s:find("avail") then
        return Color3.fromRGB(80, 150, 255), Color3.fromRGB(20, 40, 80)
    elseif s:find("hacked") or s:find("done") or s:find("complete") or s == "1" then
        return Color3.fromRGB(90, 230, 120), Color3.fromRGB(16, 80, 24)
    elseif s:find("wrong") or s:find("failed") or s:find("error") or s == "-1" then
        return Color3.fromRGB(255, 80, 80), Color3.fromRGB(120, 24, 24)
    elseif s:find("progress") or s:find("hacking") then
        return Color3.fromRGB(255, 200, 90), Color3.fromRGB(130, 90, 20)
    else
        return Color3.fromRGB(120, 200, 255), Color3.fromRGB(20, 40, 80)
    end
end

local function createHighlight(model, fillColor, outlineColor, transparency, outlineTransparency)
    local highlight = Instance.new("Highlight")
    highlight.Adornee = model
    highlight.FillColor = fillColor
    highlight.OutlineColor = outlineColor
    highlight.FillTransparency = transparency
    highlight.OutlineTransparency = outlineTransparency
    highlight.Parent = workspace
    return highlight
end

local function updateHighlightColorFromScreen(model, highlight)
    local screen = model:FindFirstChild("Screen")
    if screen then
        highlight.FillColor = screen.Color
        highlight.OutlineColor = screen.Color:Lerp(Color3.fromRGB(0, 0, 0), 0.5)
    end
end

local function updateComputerVisual(model)
    if not model then return end
    local info = computerInfo[model] or {}
    local state = getModelState(model)
    local fill, outline = stateColorsFor(state)

    if info.highlight and info.highlight.Parent then
        info.highlight.FillColor = fill
        info.highlight.OutlineColor = outline
    else
        info.highlight = createHighlight(model, fill, outline, 0.06, 0)
    end

    updateHighlightColorFromScreen(model, info.highlight)

    computerInfo[model] = info
end

local function wireComputerModel(model)
    if not model then return end
    local info = computerInfo[model] or { conns = {} }

    if info.conns then 
        for _, c in ipairs(info.conns) do 
            pcall(function() c:Disconnect() end)
        end 
    end
    info.conns = {}

    local function tryWire(obj)
        if obj:IsA("BoolValue") or obj:IsA("StringValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") then
            local c = obj.Changed:Connect(function() updateComputerVisual(model) end)
            table.insert(info.conns, c)
        end
    end

    for _, d in ipairs(model:GetDescendants()) do tryWire(d) end

    local addConn = model.DescendantAdded:Connect(function(d)
        tryWire(d)
        updateComputerVisual(model)
    end)
    table.insert(info.conns, addConn)

    computerInfo[model] = info
end

for _, d in ipairs(workspace:GetDescendants()) do
    if d:IsA("Model") and isComputerCandidate(d) then
        updateComputerVisual(d)
        wireComputerModel(d)
    end
end

workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("Model") and isComputerCandidate(obj) then
        updateComputerVisual(obj)
        wireComputerModel(obj)
    end
end)

workspace.DescendantRemoving:Connect(function(obj)
    if obj:IsA("Model") and computerInfo[obj] then
        local info = computerInfo[obj]
        if info.highlight then info.highlight:Destroy() end
        if info.conns then 
            for _, c in ipairs(info.conns) do 
                pcall(function() c:Disconnect() end) 
            end 
        end
        computerInfo[obj] = nil
    end
end)
